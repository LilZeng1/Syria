const translations = {
    en: {
        statText: "1,800+ Members — Missing You!",
        heroTitle: "The Heart <br> <span class='italic serif text-transparent bg-clip-text bg-gradient-to-r from-levant-gold via-yellow-200 to-levant-gold animate-gradient-x'>Of The Levant.</span>",
        heroSub: "Forget regular servers. This is where the real ones hang out.",
        enterBtn: "<i class='bx bxl-discord-alt text-2xl group-hover:rotate-12 transition-transform'></i> Jump In Discord",
        exploreBtn: "Explore Heritage",
        schedTitle: "The Schedule",
        revTitle: "The Family",
        galleryTitle: "Moments",
        gallerySub: "The history we build together",
        faqTitle: "Quick Q<span class='text-levant-gold'>&</span>A",
        faqQ1: "How do I verify?",
        faqA1: "You need to send an application to our staff. You will be asked:<ol class='list-decimal list-inside space-y-2 ml-2 marker:text-levant-gold'><li>What is your country of origin and how old are you?</li><li>Why do you want to join this server? What do you expect from it?</li><li>On a scale from 1 to 10, how tolerant are you of opinions that differ from your beliefs?</li></ol>",
        faqQ2: "Are non-Syrians welcome?",
        faqA2: "100%. If you vibe with the culture and respect the rules, you're family.",
        protocolTitle: "System <span class='text-levant-gold'>Protocols</span>",
        protocolSub: "/// READ_BEFORE_ENTRY",
        
        rule1Title: "Respect",
        rule1Desc: "Treat everyone as you wish to be treated. We are a family.",
        rule2Title: "Privacy",
        rule2Desc: "No leaking. Personal info stays private. Red line.",
        rule3Title: "No Hate",
        rule3Desc: "Racism and hate speech = Immediate ban. Zero tolerance.",
        rule4Title: "Clean Content",
        rule4Desc: "No NSFW, gore, or disturbing content. Keep it classy.",
        rule5Title: "Safe Links",
        rule5Desc: "Clarify before posting files or links to avoid auto-ban.",
        rule6Title: "No Spam",
        rule6Desc: "Don't abuse @everyone or ping staff without reason.",
        rule7Title: "Debate Ideas",
        rule7Desc: "Attack the argument, not the person. Be civilized.",
        rule8Title: "Organize",
        rule8Desc: "Use the correct channels for your content.",
        rule9Title: "Real Identity",
        rule9Desc: "No impersonation or fake accounts. Transparency is key.",
        rule10Title: "No Drama",
        rule10Desc: "Resolve issues privately with staff. Don't make a scene.",
        rule11Title: "No Harassment",
        rule11Desc: "We are civilized humans, not wild animals. Harassment is strictly prohibited.",

        aboutTitle: "The Dream of <span class='text-levant-gold'>Unity</span>"
    },
    ar: {
        statText: "أكثر من ١٨٠٠ عضو — مكانك فاضي!",
        heroTitle: "قلب <br> <span class='italic serif text-transparent bg-clip-text bg-gradient-to-r from-levant-gold via-yellow-200 to-levant-gold animate-gradient-x'>بلاد الشام.</span>",
        heroSub: "انسَ السيرفرات العادية. هنا العائلة الحقيقية.",
        enterBtn: "<i class='bx bxl-discord-alt text-2xl group-hover:rotate-12 transition-transform'></i> ادخل السيرفر",
        exploreBtn: "اكتشف التراث",
        schedTitle: "جدولنا",
        revTitle: "العائلة",
        galleryTitle: "لحظات",
        gallerySub: "تاريخنا سوا",
        faqTitle: "سؤال <span class='text-levant-gold'>و</span> جواب",
        faqQ1: "كيف بوثق حسابي؟",
        faqA1: "لازم تقدم طلب للادارة، رح تنسأل اسئلة بسيطة:<ol class='list-decimal list-inside space-y-2 ml-2 marker:text-levant-gold'><li>من أي بلد أنت وكم عمرك؟</li><li>ليش حابب تنضم للسيرفر؟ وشو متوقع منو؟</li><li>من ١ لـ ١٠، قديش بتتقبل الآراء اللي بتخالفك؟</li></ol>",
        faqQ2: "هل مسموح لغير السوريين؟",
        faqA2: "أكيد ١٠٠٪. طالما بتحترم القوانين، أنت من العيلة.",
        protocolTitle: "قوانين <span class='text-levant-gold'>النظام</span>",
        protocolSub: "/// اقرأ_قبل_الدخول",

        rule1Title: "الاحترام",
        rule1Desc: "عامل الناس كما تحب أن تُعامل. نحترم بعض، نناقش بأدب.",
        rule2Title: "الخصوصية",
        rule2Desc: "ممنوع مشاركة صور، أصوات، أو أي معلومة شخصية بدون إذن.",
        rule3Title: "لا للكراهية",
        rule3Desc: "خطاب الكراهية، العنصرية، التمييز بكل أنواعه = طرد مباشر.",
        rule4Title: "محتوى نظيف",
        rule4Desc: "المحتوى الجنسي، الدموي، أو التحريضي ممنوع كلياً.",
        rule5Title: "روابط آمنة",
        rule5Desc: "ما تنشر أي روابط أو ملفات مش واضحة. وضّح قبل ما تنشر.",
        rule6Title: "بدون إزعاج",
        rule6Desc: "لا تستخدم @ للجميع أو للإدارة بدون سبب ضروري.",
        rule7Title: "نقاش راقي",
        rule7Desc: "ناقش الفكرة مش الشخص. نحن هون لسماع كل وجهات النظر.",
        rule8Title: "التنظيم",
        rule8Desc: "شارك المحتوى بالقنوات المناسبة. ما تخرب التنظيم.",
        rule9Title: "هوية حقيقية",
        rule9Desc: "لا تتقمص شخصيات غيرك ولا تصنع حسابات وهمية. كن نفسك.",
        rule10Title: "بلا دراما",
        rule10Desc: "السيرفر مو ساحة دراما أو مشاكل شخصية. حل مشاكلك بهدوء.",
        rule11Title: "ممنوع التحرش",
        rule11Desc: "كون نحنا مو عايشين بغابة ونحن بشر راقين، التحرش ممنوع.",

        aboutTitle: "حلم <span class='text-levant-gold'>الوحدة</span>"
    }
};

let currentLang = 'en';
let particleInstance;

const interactables = document.querySelectorAll('.interactable');
interactables.forEach(el => {
    el.addEventListener('mouseenter', () => {
        document.body.classList.add('hovering-interactable');
    });
    el.addEventListener('mouseleave', () => {
        document.body.classList.remove('hovering-interactable');
    });
});

const phrases = [
    "Not just another server—it's home.", 
    "From heated debates to 3 AM gaming.", 
    "Come as you are, stay for the family."
];
let phraseIndex = 0;
let charIndex = 0;
let isDeleting = false;
const typeTarget = document.getElementById('hero-sub');

function typeEffect() {
    const currentPhrase = phrases[phraseIndex];
    if(isDeleting) {
        typeTarget.innerText = currentPhrase.substring(0, charIndex - 1);
        charIndex--;
    } else {
        typeTarget.innerText = currentPhrase.substring(0, charIndex + 1);
        charIndex++;
    }

    if(!isDeleting && charIndex === currentPhrase.length) {
        setTimeout(() => isDeleting = true, 2000);
    } else if (isDeleting && charIndex === 0) {
        isDeleting = false;
        phraseIndex = (phraseIndex + 1) % phrases.length;
    }

    const speed = isDeleting ? 30 : 50;
    setTimeout(typeEffect, speed);
}

window.addEventListener('load', () => {
    setTimeout(() => {
        document.getElementById('loader').classList.add('hidden-loader');
        reveal();
        initStarfield();
        initTilt();
        initSettingsPanel();
        typeEffect();
        updateTime();
        initAudioPlayer();
        setInterval(updateTime, 1000);
    }, 1500);
});

function toggleMenu() {
    const menu = document.getElementById('mobile-menu');
    const isOpen = menu.style.transform === 'translateX(0%)';
    menu.style.transform = isOpen ? 'translateX(100%)' : 'translateX(0%)';
}
document.getElementById('open-menu').addEventListener('click', toggleMenu);
document.getElementById('close-menu').addEventListener('click', toggleMenu);

function reveal() {
    const reveals = document.querySelectorAll('.reveal');
    reveals.forEach(el => {
        const windowHeight = window.innerHeight;
        const revealTop = el.getBoundingClientRect().top;
        if (revealTop < windowHeight - 50) {
            el.classList.add('active');
        }
    });
}
window.addEventListener('scroll', reveal);

const modal = document.getElementById('upload-modal');
const btn = document.getElementById('upload-btn');
const close = document.getElementById('close-upload');
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const previewContainer = document.getElementById('preview-container');
const imagePreview = document.getElementById('image-preview');
const submitBtn = document.getElementById('submit-upload');
const errorOverlay = document.getElementById('error-overlay');
const dropVisuals = document.getElementById('drop-visuals');

function openModal() {
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        document.getElementById('upload-content').classList.remove('scale-95');
    }, 10);
}

function closeModal() {
    modal.classList.add('opacity-0');
    document.getElementById('upload-content').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        resetForm();
    }, 300);
}

function resetForm() {
    fileInput.value = '';
    previewContainer.classList.add('hidden');
    imagePreview.src = '';
    dropVisuals.classList.remove('border-red-500', 'bg-red-500/10');
}

btn.addEventListener('click', openModal);
close.addEventListener('click', closeModal);
modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
});

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropVisuals.classList.add('border-levant-gold', 'bg-levant-gold/20');
    });
});
['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        dropVisuals.classList.remove('border-levant-gold', 'bg-levant-gold/20');
    });
});

function handleFile(file) {
    const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        return;
    }
    const reader = new FileReader();
    reader.onload = function (e) {
        imagePreview.src = e.target.result;
        previewContainer.classList.remove('hidden');
    }
    reader.readAsDataURL(file);
}

dropZone.addEventListener('drop', (e) => {
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
});

fileInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file) handleFile(file);
});

submitBtn.addEventListener('click', () => {
    if (!fileInput.files[0] && !imagePreview.src) return;
    submitBtn.innerHTML = '<i class="bx bx-loader-alt animate-spin text-xl"></i> UPLOADING...';
    setTimeout(() => {
        const newCard = document.createElement('div');
        newCard.className = 'break-inside-avoid glass-card rounded-[2rem] p-2 group hover:rotate-2 transition-transform duration-300 reveal active interactable';
        newCard.innerHTML = `
            <div class="bg-gray-800 rounded-[1.8rem] overflow-hidden relative">
                <img src="${imagePreview.src}" class="w-full h-auto object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-6">
                     <span class="text-[10px] font-black uppercase tracking-widest text-white">Just Now</span>
                </div>
            </div>
        `;
        const grid = document.getElementById('gallery-grid');
        grid.prepend(newCard);
        closeModal();
        submitBtn.innerHTML = '<span class="relative z-10">Initialize Upload</span><div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>';
    }, 1500);
});

function initStarfield() {
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];
    const maxStars = 150;

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }

    function Star() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.vx = (Math.random() - 0.5) * 0.2;
        this.vy = (Math.random() - 0.5) * 0.2;
        this.size = Math.random() * 2;
        this.alpha = Math.random();
    }

    Star.prototype.update = function () {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0) this.x = width;
        if (this.x > width) this.x = 0;
        if (this.y < 0) this.y = height;
        if (this.y > height) this.y = 0;
        this.alpha += (Math.random() - 0.5) * 0.05;
        if (this.alpha < 0) this.alpha = 0;
        if (this.alpha > 1) this.alpha = 1;
    }

    Star.prototype.draw = function () {
        ctx.fillStyle = "white";
        ctx.globalAlpha = this.alpha;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }

    for (let i = 0; i < maxStars; i++) stars.push(new Star());

    function animate() {
        ctx.clearRect(0, 0, width, height);
        stars.forEach(star => {
            star.update();
            star.draw();
        });
        requestAnimationFrame(animate);
    }
    
    window.addEventListener('resize', resize);
    resize();
    animate();
}

function initSettingsPanel() {
    const trigger = document.getElementById('portal-trigger');
    const panel = document.getElementById('settings-panel');
    const overlay = document.getElementById('settings-overlay');
    const closeBtn = document.getElementById('close-settings');
    const themeBtns = document.querySelectorAll('.theme-btn');
    const matrixToggle = document.getElementById('toggle-matrix');
    const particleToggle = document.getElementById('toggle-particles');
    const volumeSlider = document.getElementById('volume-slider');

    function togglePanel() {
        const isClosed = panel.style.transform === 'translateX(100%)' || panel.style.transform === '';
        
        if (isClosed) {
            panel.style.transform = 'translateX(0)';
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        } else {
            panel.style.transform = 'translateX(100%)';
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 500);
        }
    }

    trigger.addEventListener('click', togglePanel);
    closeBtn.addEventListener('click', togglePanel);
    overlay.addEventListener('click', togglePanel);

    themeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const color = btn.getAttribute('data-color');
            document.documentElement.style.setProperty('--accent-color', color);
            themeBtns.forEach(b => b.classList.remove('scale-110'));
            btn.classList.add('scale-110');
        });
    });

    let matrixInterval;
    let isMatrixOn = false;
    matrixToggle.addEventListener('click', () => {
        isMatrixOn = !isMatrixOn;
        const sw = document.getElementById('matrix-switch');
        const knob = sw.querySelector('div');
        
        sw.className = isMatrixOn ? 'w-10 h-5 bg-green-500 rounded-full relative transition-colors duration-300' : 'w-10 h-5 bg-gray-700 rounded-full relative transition-colors duration-300';
        knob.style.transform = isMatrixOn ? 'translateX(20px)' : 'translateX(0)';
        
        document.getElementById('matrix-canvas').style.opacity = isMatrixOn ? '0.1' : '0';

        if (isMatrixOn) startMatrix();
        else clearInterval(matrixInterval);
    });

    let isParticlesOn = true;
    particleToggle.addEventListener('click', () => {
        isParticlesOn = !isParticlesOn;
        const sw = document.getElementById('particle-switch');
        const knob = sw.querySelector('div');
        
        sw.className = isParticlesOn ? 'w-10 h-5 bg-green-500 rounded-full relative transition-colors duration-300' : 'w-10 h-5 bg-gray-700 rounded-full relative transition-colors duration-300';
        knob.style.transform = isParticlesOn ? 'translateX(20px)' : 'translateX(0)';
        
        const canvas = document.getElementById('starfield');
        canvas.style.opacity = isParticlesOn ? '0.6' : '0';
    });

    volumeSlider.addEventListener('input', (e) => {
        const audio = document.getElementById('bg-music');
        audio.volume = e.target.value / 100;
    });

    function startMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const alphabet = katakana + latin + nums;
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = [];

        for (let x = 0; x < columns; x++) drops[x] = 1;

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
            ctx.fillStyle = accent;
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }
        clearInterval(matrixInterval);
        matrixInterval = setInterval(draw, 30);
    }
}

function initAudioPlayer() {
    const audio = document.getElementById('bg-music');
    const toggle = document.getElementById('toggle-music');
    const visualizer = document.getElementById('audio-visualizer');
    let isPlaying = false;

    toggle.addEventListener('click', () => {
        if (isPlaying) {
            audio.pause();
            toggle.innerHTML = "<i class='bx bx-play'></i>";
            Array.from(visualizer.children).forEach(bar => bar.style.animationPlayState = 'paused');
        } else {
            audio.play();
            toggle.innerHTML = "<i class='bx bx-pause'></i>";
            Array.from(visualizer.children).forEach(bar => bar.style.animationPlayState = 'running');
        }
        isPlaying = !isPlaying;
    });
    
    Array.from(visualizer.children).forEach(bar => bar.style.animationPlayState = 'paused');
    audio.volume = 0.5;
}

function initTilt() {
    const cards = document.querySelectorAll('.tilt-card');
    cards.forEach(card => {
        card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const rotateX = ((y - centerY) / centerY) * -10;
            const rotateY = ((x - centerX) / centerX) * 10;
            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
        });
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
        });
    });
}

function updateTime() {
    const now = new Date();
    const options = {
        timeZone: 'Asia/Damascus',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    const timeString = new Intl.DateTimeFormat('en-US', options).format(now);
    document.getElementById('clock-display').innerText = timeString;
}

document.getElementById('lang-toggle').addEventListener('click', () => {
    currentLang = currentLang === 'en' ? 'ar' : 'en';
    updateLanguage();
});
document.getElementById('lang-toggle-mob').addEventListener('click', () => {
    currentLang = currentLang === 'en' ? 'ar' : 'en';
    updateLanguage();
    setTimeout(toggleMenu, 600);
});

function updateLanguage() {
    const t = translations[currentLang];
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.body.style.opacity = '0';
    setTimeout(() => {
        document.getElementById('stat-text').innerText = t.statText;
        document.getElementById('hero-title').innerHTML = t.heroTitle;
        phraseIndex = 0; charIndex = 0; isDeleting = false;
        
        document.getElementById('enter-btn').innerHTML = t.enterBtn;
        document.getElementById('explore-btn').innerText = t.exploreBtn;
        document.getElementById('sched-title').innerHTML = t.schedTitle + " <i class='bx bxs-zap text-4xl text-yellow-400 absolute -top-4 -right-8 animate-pulse'></i>";
        document.getElementById('rev-title').innerText = t.revTitle;
        document.getElementById('about-title').innerHTML = t.aboutTitle;
        
        document.getElementById('gallery-title').innerText = t.galleryTitle;
        document.getElementById('gallery-sub').innerText = t.gallerySub;
        document.getElementById('faq-title').innerHTML = t.faqTitle;
        document.getElementById('faq-q1').innerText = t.faqQ1;
        document.getElementById('faq-a1').innerHTML = t.faqA1;
        document.getElementById('faq-q2').innerText = t.faqQ2;
        document.getElementById('faq-a2').innerText = t.faqA2;
        
        document.getElementById('protocol-title').innerHTML = t.protocolTitle;
        document.getElementById('protocol-sub').innerText = t.protocolSub;

        for (let i = 1; i <= 11; i++) {
            const titleEl = document.getElementById(`rule-${i}-title`);
            const descEl = document.getElementById(`rule-${i}-desc`);
            if (titleEl && descEl) {
                titleEl.innerText = t[`rule${i}Title`];
                descEl.innerText = t[`rule${i}Desc`];
            }
        }

        document.body.style.opacity = '1';
        reveal();
    }, 400);
}
